<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout Journal</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
  #appSection { display: none; }
  textarea { width: 100%; height: 80px; margin-top: 0.5rem; }
  #pastWorkouts > div { border: 1px solid #ccc; padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
  button { padding: 0.5rem 1rem; margin-top: 0.5rem; }
  .deleteBtn { background-color: #e74c3c; color: white; border: none; cursor: pointer; padding: 0.3rem 0.6rem; border-radius: 3px; }
  .deleteBtn:hover { background-color: #c0392b; }
</style>
</head>
<body>

<h1>Workout Journal</h1>

<div id="loginSection">
  <p>Please enter your username to log in:</p>
  <input type="text" id="usernameInput" placeholder="Your username" />
  <button id="loginBtn">Log In</button>
</div>

<div id="appSection">
  <p>Logged in as <span id="displayUsername"></span> <button id="logoutBtn" style="float:right;">Log Out</button></p>

  <label for="workoutDate">Select Date:</label>
  <input type="date" id="workoutDate" />

  <textarea id="workoutText" placeholder="Write your workout..."></textarea>
  <br />
  <button id="saveWorkoutBtn">Save Workout</button>

  <h3>Past 6 Workouts</h3>
  <div id="pastWorkouts">Loading...</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC3Jon13meRVHu1-Wj7nGQbrevEi8LynbU",
    authDomain: "workoutjournal-c02f1.firebaseapp.com",
    projectId: "workoutjournal-c02f1",
    storageBucket: "workoutjournal-c02f1.firebasestorage.app",
    messagingSenderId: "554426612853",
    appId: "1:554426612853:web:4bc9958b0e3fc18c758c3c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('appSection');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const usernameInput = document.getElementById('usernameInput');
  const displayUsername = document.getElementById('displayUsername');
  const workoutDate = document.getElementById('workoutDate');
  const workoutText = document.getElementById('workoutText');
  const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');
  const pastWorkouts = document.getElementById('pastWorkouts');

  let currentUser = null;

  function checkLogin() {
    const savedUser = localStorage.getItem('workoutUser');
    if (savedUser) {
      loginUser(savedUser);
    }
  }

  function loginUser(username) {
    currentUser = username;
    localStorage.setItem('workoutUser', username);
    displayUsername.textContent = username;
    loginSection.style.display = 'none';
    appSection.style.display = 'block';

    workoutDate.value = new Date().toISOString().slice(0,10);

    loadWorkoutForDate(workoutDate.value);
    loadPastWorkouts();
  }

  function logoutUser() {
    localStorage.removeItem('workoutUser');
    currentUser = null;
    loginSection.style.display = 'block';
    appSection.style.display = 'none';
  }

  loginBtn.onclick = () => {
    const username = usernameInput.value.trim();
    if (!username) {
      alert('Please enter a username.');
      return;
    }
    loginUser(username);
  };

  logoutBtn.onclick = logoutUser;

  async function loadWorkoutForDate(date) {
    workoutText.value = "Loading...";
    try {
      const snapshot = await db.collection('workouts')
        .where('username', '==', currentUser)
        .where('date', '==', date)
        .limit(1)
        .get();

      if (!snapshot.empty) {
        workoutText.value = snapshot.docs[0].data().text;
      } else {
        workoutText.value = '';
      }
    } catch (e) {
      workoutText.value = '';
      alert("Failed to load workout: " + e.message);
    }
  }

  async function saveWorkout() {
    const date = workoutDate.value;
    const text = workoutText.value.trim();

    if (!text) {
      alert('Please enter a workout.');
      return;
    }

    try {
      const snapshot = await db.collection('workouts')
        .where('username', '==', currentUser)
        .where('date', '==', date)
        .limit(1)
        .get();

      if (!snapshot.empty) {
        const docId = snapshot.docs[0].id;
        await db.collection('workouts').doc(docId).update({
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        await db.collection('workouts').add({
          username: currentUser,
          date,
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      alert('Workout saved!');
      loadPastWorkouts();
    } catch (e) {
      alert("Error saving workout: " + e.message);
    }
  }

  async function deleteWorkout(docId) {
    if (!confirm("Are you sure you want to delete this workout?")) return;
    try {
      await db.collection('workouts').doc(docId).delete();
      alert('Workout deleted.');
      loadPastWorkouts();
    } catch (e) {
      alert("Error deleting workout: " + e.message);
    }
  }

  async function loadPastWorkouts() {
    pastWorkouts.innerHTML = "Loading...";
    try {
      const snapshot = await db.collection('workouts')
        .where('username', '==', currentUser)
        .orderBy('timestamp', 'desc')
        .limit(6)
        .get();

      if (snapshot.empty) {
        pastWorkouts.innerHTML = "<p>No past workouts.</p>";
        return;
      }

      pastWorkouts.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        div.style.alignItems = 'center';

        const textSpan = document.createElement('span');
        textSpan.textContent = `${data.date}: ${data.text}`;

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.className = 'deleteBtn';
        delBtn.onclick = () => deleteWorkout(doc.id);

        div.appendChild(textSpan);
        div.appendChild(delBtn);
        pastWorkouts.appendChild(div);
      });
    } catch (e) {
      pastWorkouts.innerHTML = "<p>Failed to load past workouts.</p>";
      alert("Error loading past workouts: " + e.message);
    }
  }

  workoutDate.addEventListener('change', () => loadWorkoutForDate(workoutDate.value));
  saveWorkoutBtn.addEventListener('click', saveWorkout);

  checkLogin();
</script>

</body>
</html>
