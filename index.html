<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Workout Journal</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; }
  #appSection { display: none; }
  textarea { width: 100%; height: 80px; margin-top: 0.5rem; }
  #pastWorkouts > div { border: 1px solid #ccc; padding: 0.5rem; margin: 0.25rem 0; border-radius: 4px; }
  button { padding: 0.5rem 1rem; margin-top: 0.5rem; }
</style>
</head>
<body>

<h1>Workout Journal</h1>

<div id="loginSection">
  <p>Please log in with your Google account:</p>
  <button id="loginBtn">Log In</button>
</div>

<div id="appSection">
  <label for="workoutDate">Select Date:</label>
  <input type="date" id="workoutDate" />

  <textarea id="workoutText" placeholder="Write your workout..."></textarea>
  <br />
  <button id="saveWorkoutBtn">Save Workout</button>
  <button id="logoutBtn" style="float:right;">Log Out</button>

  <h3>Past 6 Workouts</h3>
  <div id="pastWorkouts">Loading...</div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
  // Your Firebase config - REPLACE these with your own project's values!
  const firebaseConfig = {
    apiKey: "AIzaSyC3Jon13meRVHu1-Wj7nGQbrevEi8LynbU",
    authDomain: "workoutjournal-c02f1.firebaseapp.com",
    projectId: "workoutjournal-c02f1",
    storageBucket: "workoutjournal-c02f1.firebasestorage.app",
    messagingSenderId: "554426612853",
    appId: "1:554426612853:web:4bc9958b0e3fc18c758c3c"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('appSection');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const workoutDate = document.getElementById('workoutDate');
  const workoutText = document.getElementById('workoutText');
  const saveWorkoutBtn = document.getElementById('saveWorkoutBtn');
  const pastWorkouts = document.getElementById('pastWorkouts');

  let currentUser = null;

  // Login with Google popup
  loginBtn.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => alert("Login failed: " + e.message));
  };

  // Logout
  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // Listen for auth state changes
  auth.onAuthStateChanged(async user => {
    if (user) {
      currentUser = user.email;
      loginSection.style.display = 'none';
      appSection.style.display = 'block';

      // Set date picker to today on load
      workoutDate.value = new Date().toISOString().slice(0,10);

      // Load workout for selected date
      await loadWorkoutForDate(workoutDate.value);

      // Load past 6 workouts
      await loadPastWorkouts();
    } else {
      currentUser = null;
      loginSection.style.display = 'block';
      appSection.style.display = 'none';
    }
  });

  // Load workout for a specific date
  async function loadWorkoutForDate(date) {
    workoutText.value = "Loading...";
    try {
      const snapshot = await db.collection('workouts')
        .where('username', '==', currentUser)
        .where('date', '==', date)
        .limit(1)
        .get();

      if (!snapshot.empty) {
        workoutText.value = snapshot.docs[0].data().text;
      } else {
        workoutText.value = '';
      }
    } catch (e) {
      workoutText.value = '';
      alert("Failed to load workout: " + e.message);
    }
  }

  // Save or update workout for selected date
  async function saveWorkout() {
    const date = workoutDate.value;
    const text = workoutText.value.trim();

    if (!text) {
      alert('Please enter a workout.');
      return;
    }

    try {
      const snapshot = await db.collection('workouts')
        .where('username', '==', currentUser)
        .where('date', '==', date)
        .limit(1)
        .get();

      if (!snapshot.empty) {
        // Update existing
        const docId = snapshot.docs[0].id;
        await db.collection('workouts').doc(docId).update({
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        // Add new workout
        await db.collection('workouts').add({
          username: currentUser,
          date,
          text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
      alert('Workout saved!');
      loadPastWorkouts();
    } catch (e) {
      alert("Error saving workout: " + e.message);
    }
  }

  // Load last 6 workouts and display them
  async function loadPastWorkouts() {
    pastWorkouts.innerHTML = "Loading...";
    try {
      const snapshot = await db.collection('workouts')
        .where('username', '==', currentUser)
        .orderBy('timestamp', 'desc')
        .limit(6)
        .get();

      if (snapshot.empty) {
        pastWorkouts.innerHTML = "<p>No past workouts.</p>";
        return;
      }

      pastWorkouts.innerHTML = '';
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.textContent = `${data.date}: ${data.text}`;
        pastWorkouts.appendChild(div);
      });
    } catch (e) {
      pastWorkouts.innerHTML = "<p>Failed to load past workouts.</p>";
      alert("Error loading past workouts: " + e.message);
    }
  }

  // Update workout text when date changes
  workoutDate.addEventListener('change', () => loadWorkoutForDate(workoutDate.value));
  saveWorkoutBtn.addEventListener('click', saveWorkout);
</script>
</body>
</html>
